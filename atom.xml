<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>冷雨茶的小窝</title>
  
  <subtitle>Blog of coldraintea</subtitle>
  <link href="https://coldraintea.github.io/atom.xml" rel="self"/>
  
  <link href="https://coldraintea.github.io/"/>
  <updated>2022-09-27T13:58:18.120Z</updated>
  <id>https://coldraintea.github.io/</id>
  
  <author>
    <name>冷雨茶</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Wsl2安装后配置</title>
    <link href="https://coldraintea.github.io/2022/09/27/Wsl2%E5%AE%89%E8%A3%85%E5%90%8E%E9%85%8D%E7%BD%AE/"/>
    <id>https://coldraintea.github.io/2022/09/27/Wsl2%E5%AE%89%E8%A3%85%E5%90%8E%E9%85%8D%E7%BD%AE/</id>
    <published>2022-09-26T19:27:30.000Z</published>
    <updated>2022-09-27T13:58:18.120Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Win11安装wsl2及配置"><a href="#Win11安装wsl2及配置" class="headerlink" title="Win11安装wsl2及配置"></a>Win11安装wsl2及配置</h1><h2 id="安装Wsl2"><a href="#安装Wsl2" class="headerlink" title="安装Wsl2"></a>安装Wsl2</h2><h3 id="启用hyper-v和wsl"><a href="#启用hyper-v和wsl" class="headerlink" title="启用hyper-v和wsl"></a>启用hyper-v和wsl</h3><ul><li>打开设置-应用-可选功能-更多Windows功能</li><li>勾选 Hyper-V 适用于Linux的windows子系统 虚拟机平台 点击确定并重启</li></ul><h3 id="安装wsl预览版"><a href="#安装wsl预览版" class="headerlink" title="安装wsl预览版"></a>安装wsl预览版</h3><ul><li><p>从Github下载 <a href="https://github.com/microsoft/WSL/releases/">WSL Pre-release msixbundle包</a></p></li><li><p>安装msixbundle包</p>  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-AppxPackage</span> <span class="string">&quot;D:\downloads\Microsoft.WSL_0.67.6.0_x64_ARM64.msixbundle&quot;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="安装-Linux-发行版"><a href="#安装-Linux-发行版" class="headerlink" title="安装 Linux 发行版"></a>安装 Linux 发行版</h3><ul><li>查看可用的发行版<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\lpc10&gt; wsl <span class="literal">--list</span> <span class="literal">--online</span></span><br><span class="line">以下是可安装的有效分发的列表。</span><br><span class="line">使用‘wsl.exe <span class="literal">--install</span> &lt;Distro&gt;<span class="string">&#x27;安装。                                                                                                                                                                                NAME               FRIENDLY NAME</span></span><br><span class="line"><span class="string">Ubuntu             Ubuntu</span></span><br><span class="line"><span class="string">Debian             Debian GNU/Linux</span></span><br><span class="line"><span class="string">kali-linux         Kali Linux Rolling</span></span><br><span class="line"><span class="string">SLES-12            SUSE Linux Enterprise Server v12</span></span><br><span class="line"><span class="string">SLES-15            SUSE Linux Enterprise Server v15</span></span><br><span class="line"><span class="string">Ubuntu-18.04       Ubuntu 18.04 LTS</span></span><br><span class="line"><span class="string">Ubuntu-20.04       Ubuntu 20.04 LTS</span></span><br><span class="line"><span class="string">OracleLinux_8_5    Oracle Linux 8.5</span></span><br><span class="line"><span class="string">OracleLinux_7_9    Oracle Linux 7.9</span></span><br></pre></td></tr></table></figure></li><li>安装 Debian<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl <span class="literal">--install</span> Debian</span><br></pre></td></tr></table></figure></li><li>设置Wsl 为Wsl2 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl <span class="literal">--set-version</span> Debian <span class="number">2</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="编译内核启用KVM-可选"><a href="#编译内核启用KVM-可选" class="headerlink" title="编译内核启用KVM(可选)"></a>编译内核启用KVM(可选)</h2><ul><li>使用 KVM 需要内核功能支持，我们需要自行编译内核加入 KVM 支持。</li></ul><h3 id="升级系统，安装编译环境"><a href="#升级系统，安装编译环境" class="headerlink" title="升级系统，安装编译环境"></a>升级系统，安装编译环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt -y upgrade</span><br><span class="line">sudo apt -y install build-essential libncurses-dev bison flex libssl-dev libelf-dev cpu-checker qemu-kvm libvirtd virt-manager git</span><br></pre></td></tr></table></figure><h3 id="获得内核源码"><a href="#获得内核源码" class="headerlink" title="获得内核源码"></a>获得内核源码</h3><ul><li><p>可以使用 Linux 官方源码，但我使用了微软专门为 WSL 2 修改后的源码。需要访问 Github</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/microsoft/WSL2-Linux-Kernel.git</span><br><span class="line"><span class="built_in">cd</span> WSL2-Linux-Kernel</span><br><span class="line">git checkout linux-msft-wsl-5.15.62.1</span><br></pre></td></tr></table></figure></li><li><p>我使用了 5.15 版本内核，可以根据自己的需要切换到其他分支使用当前系统的 config，修改后编译内核</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zcat /proc/config.gz &gt; .config</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure></li><li><p>在 Virtualization 中确认 Intel 支持已被选中，virtio-net 也被选中 ( 如果有 )</p></li><li><p>按两次 ESC，再导航至 Processor type and features -&gt; Linux guest support，确定 KVM Guest support 已被选中</p></li><li><p>可以编译成模块再加载，但我选择直接编译进内核，同时可以编译 Multipath 依赖的支持，以便后续 systemd 可以少一个报错</p></li><li><p>保存并退出</p></li></ul><h3 id="编译-第一次编译要蛮久"><a href="#编译-第一次编译要蛮久" class="headerlink" title="编译(第一次编译要蛮久)"></a>编译(第一次编译要蛮久)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j 8</span><br></pre></td></tr></table></figure><ul><li>如遇到错误请安装 bc 和 dwarves</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install bc dwarves</span><br></pre></td></tr></table></figure><h3 id="安装新内核"><a href="#安装新内核" class="headerlink" title="安装新内核"></a>安装新内核</h3><ul><li><p>将编译好的内核拷贝到当前用户的家目录 ( Windows 这边！) 并且配置使用新内核</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> <span class="built_in">arch</span>/x86/boot/bzImage /mnt/c/Users/&lt;username&gt;/bzImage</span><br><span class="line">vim /mnt/c/Users/&lt;username&gt;/.wslconfig</span><br></pre></td></tr></table></figure></li><li><p>不会用 vim 真的别强求，用 nano 就好了</p></li><li><p>注意将 替换成自己的用户名</p></li><li><p>将以下内容粘贴，并修改 为自己的用户名</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nestedVirtualization=true</span><br><span class="line">kernel=C:\\Users\\&lt;username&gt;\\bzImage</span><br></pre></td></tr></table></figure><h3 id="配置KVM"><a href="#配置KVM" class="headerlink" title="配置KVM"></a>配置KVM</h3><ul><li>在 .wslconfig追加<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernelCommandLine=intel_iommu=on iommu=pt kvm.ignore_msrs=1 kvm-intel.nested=1 kvm-intel.ept=1 kvm-intel.emulate_invalid_guest_state=0 kvm-intel.enable_shadow_vmcs=1 kvm-intel.enable_apicv=1</span><br></pre></td></tr></table></figure></li></ul><h2 id="启用桥接网络并配置ipv6"><a href="#启用桥接网络并配置ipv6" class="headerlink" title="启用桥接网络并配置ipv6"></a>启用桥接网络并配置ipv6</h2><h3 id="使用Hyper-V管理器新建虚拟交换机"><a href="#使用Hyper-V管理器新建虚拟交换机" class="headerlink" title="使用Hyper-V管理器新建虚拟交换机"></a>使用Hyper-V管理器新建虚拟交换机</h3><ul><li>打开Hyper-V管理器</li><li>打开虚拟交换机管理器</li><li>选择 新建虚拟网络交换机-外部</li><li>点击 创建虚拟交换机 我的配置如下图<br><img src="https://s2.loli.net/2022/09/27/HT8eSKAqaNrzmWd.png" alt="Snipaste_2022-09-27_16-45-12.png"></li></ul><h3 id="编辑wsl-conf"><a href="#编辑wsl-conf" class="headerlink" title="编辑wsl.conf"></a>编辑wsl.conf</h3><p><code>vim /etc/wsl.conf</code></p><ul><li>加入以下内容<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[boot]</span><br><span class="line">systemd=true</span><br><span class="line"></span><br><span class="line">[network]</span><br><span class="line">hostname = WslDebian11</span><br><span class="line">generateHosts = false</span><br><span class="line">generateResolvConf = false</span><br></pre></td></tr></table></figure></li></ul><h3 id="编辑-wslconfig"><a href="#编辑-wslconfig" class="headerlink" title="编辑.wslconfig"></a>编辑.wslconfig</h3><p><code>vim /etc/mnt/c/Users/username/.wslconfig</code></p><ul><li>加入以下内容<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[wsl2]</span><br><span class="line">networkingMode=bridged</span><br><span class="line">vmSwitch=WSL2</span><br><span class="line">dhcp=false</span><br><span class="line"></span><br><span class="line">kernelCommandLine=net.ipv6.conf.all.disable_ipv6=0</span><br></pre></td></tr></table></figure></li><li>如之前配置了KVM,则.wslconfig如下<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[wsl2]</span><br><span class="line">networkingMode=bridged</span><br><span class="line">vmSwitch=WSL2</span><br><span class="line">dhcp=false</span><br><span class="line"></span><br><span class="line">nestedVirtualization=true</span><br><span class="line">kernel=C:\\Users\\lpc10\\bzImage</span><br><span class="line">kernelCommandLine=intel_iommu=on iommu=pt kvm.ignore_msrs=1 kvm-intel.nested=1 kvm-intel.ept=1 kvm-intel.emulate_invalid_guest_state=0 kvm-intel.enable_shadow_vmcs=1 kvm-intel.enable_apicv=1 net.ipv6.conf.all.disable_ipv6=0</span><br></pre></td></tr></table></figure></li></ul><h3 id="启用-systemd-networkd-service"><a href="#启用-systemd-networkd-service" class="headerlink" title="启用 systemd-networkd.service"></a>启用 systemd-networkd.service</h3><ul><li>编辑网卡配置文件<br><code> vim /etc/systemd/network/wired.network</code></li><li>加入如下内容<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Match]</span><br><span class="line">Name=eth0</span><br><span class="line"></span><br><span class="line">[Network]</span><br><span class="line">Description=Virtual switch</span><br><span class="line">DHCP=true</span><br><span class="line">IPv6AcceptRA=true</span><br><span class="line">MulticastDNS=true</span><br><span class="line">LLDP=true</span><br><span class="line">EmitLLDP=true</span><br><span class="line"></span><br><span class="line">[DHCP]</span><br><span class="line">CriticalConnection=true</span><br><span class="line">RouteMetric=10</span><br><span class="line">UseDomains=true</span><br></pre></td></tr></table></figure></li><li>启动systemd-networkd.service<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start systemd-networkd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> systemd-networkd</span><br></pre></td></tr></table></figure></li><li>配置DNS<br><code>sudo vim  /etc/resolv.conf</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nameserver 223.6.6.6</span><br><span class="line">nameserver 1.12.12.12</span><br></pre></td></tr></table></figure></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://randombytes.substack.com/p/bridged-networking-under-wsl">bridged-networking-under-wsl</a></li><li><a href="https://blog.ddupan.top/posts/%E5%9C%A8-WSL2-%E4%B8%8A%E8%8E%B7%E5%BE%97%E8%BF%91%E4%B9%8E%E5%AE%8C%E6%95%B4%E7%9A%84-Linux-%E4%BD%93%E9%AA%8C/">在 WSL2 上获得近乎完整的 Linux 体验</a></li><li><a href="https://www.v2ex.com/t/882117">WSL2 现已支持 Systemd</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Win11安装wsl2及配置&quot;&gt;&lt;a href=&quot;#Win11安装wsl2及配置&quot; class=&quot;headerlink&quot; title=&quot;Win11安装wsl2及配置&quot;&gt;&lt;/a&gt;Win11安装wsl2及配置&lt;/h1&gt;&lt;h2 id=&quot;安装Wsl2&quot;&gt;&lt;a href=&quot;</summary>
      
    
    
    
    <category term="Win11" scheme="https://coldraintea.github.io/categories/Win11/"/>
    
    
    <category term="Wsl2" scheme="https://coldraintea.github.io/tags/Wsl2/"/>
    
    <category term="Windows11" scheme="https://coldraintea.github.io/tags/Windows11/"/>
    
    <category term="ipv6" scheme="https://coldraintea.github.io/tags/ipv6/"/>
    
  </entry>
  
</feed>
